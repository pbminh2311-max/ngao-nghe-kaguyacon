<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ngạo nghễ kaguyacon</title>
<link rel="stylesheet" href="css/styles.css">
<style>
    /* Custom Scrollbar for Dev Panel */
    #devInstructionsCard::-webkit-scrollbar {
        width: 8px;
    }

    #devInstructionsCard::-webkit-scrollbar-track {
        background: rgba(15, 23, 42, 0.8); /* slate-900 */
        border-radius: 10px;
    }

    #devInstructionsCard::-webkit-scrollbar-thumb {
        background-color: #4a5568; /* slate-600 */
        border-radius: 10px;
        border: 2px solid rgba(15, 23, 42, 0.8);
    }
</style>
</head>
<body>
<div class="glow a"></div><div class="glow b"></div>
<div id="gameWrap">
<header class="card">
<div>
<h3 style="margin:0">Ngạo nghễ Kaguyacon</h3>
</div>
<div class="hud">
    <div class="info" id="msg"></div>
</div>
</header>
<section class="card top-hud" aria-label="Trạng thái trận đấu">
    <div class="top-hud-inner">
        <div class="hp p1">
            <div class="hp-label">P1</div>
            <div class="hp-bar">
                <div class="hp-fill" id="p1HpFill" style="width:100%"></div>
                <div class="hp-text" id="p1HpText">HP: 3/3</div>
            </div>
            <div class="hp-effects empty" id="p1Effects"></div>
        </div>
        <div class="scoreboard" id="scoreBoard" data-lead="tie">
            <div class="score-team p1">
                <span class="label">P1</span>
                <span class="value" id="scoreP1Value">0</span>
            </div>
            <div class="vs">VS</div>
            <div class="score-team p2">
                <span class="label">P2</span>
                <span class="value" id="scoreP2Value">0</span>
            </div>
        </div>
        <div class="hp p2">
            <div class="hp-label">P2</div>
            <div class="hp-bar">
                <div class="hp-fill" id="p2HpFill" style="width:100%"></div>
                <div class="hp-text" id="p2HpText">HP: 3/3</div>
            </div>
            <div class="hp-effects empty" id="p2Effects"></div>
        </div>
    </div>
 </section>
<section class="card instructions hidden" id="instructionsCard">
    <div class="instructions-header">
        <h4>Hướng dẫn điều khiển</h4>
        <p>Giữ phím càng lâu xe tăng càng trượt; bắn cần nạp lại mỗi 0.32s.</p>
    </div>
    <div class="instructions-grid">
        <div class="player-block tips">
            <div class="player-title">Mẹo chơi</div>
            <ul>
                <li>Đạn nảy tối đa 8 lần trừ khi buff thay đổi.</li>
                <li>Tường và biên đều phản xạ đạn — cẩn thận tự bắn mình.</li>
                <li>Giữ phím bắn để tích năng lượng đạn mạnh hơn.</li>
            </ul>
        </div>
        <div class="player-block">
            <div class="player-title">Người chơi 1</div>
            <ul>
                <li><span>Tiến / Lùi</span><kbd>W</kbd> · <kbd>S</kbd></li>
                <li><span>Quay trái / phải</span><kbd>A</kbd> · <kbd>D</kbd></li>
                <li><span>Bắn</span><kbd>Space</kbd></li>
            </ul>
        </div>
        <div class="player-block">
            <div class="player-title">Người chơi 2</div>
            <ul>
                <li><span>Tiến / Lùi</span><kbd>↑</kbd> · <kbd>↓</kbd></li>
                <li><span>Quay trái / phải</span><kbd>←</kbd> · <kbd>→</kbd></li>
                <li><span>Bắn</span><kbd>Enter</kbd></li>
            </ul>
        </div>
        <div class="player-block dev">
            <div class="player-title">Developer Mode</div>
            <p>Bật bằng nút bên phải để thử nhanh các buff.</p>
            <div id="devHint">
                <div class="hint-row"><kbd>1-0</kbd>, <kbd>Q</kbd>, <kbd>Y</kbd>, <kbd>E</kbd>, <kbd>R</kbd>, <kbd>T</kbd>, <kbd>U</kbd>, <kbd>I</kbd>, <kbd>P</kbd>, <kbd>K</kbd>, <kbd>J</kbd>, <kbd>L</kbd> = spawn buff tương ứng</div>
                <div class="hint-row"><kbd>H</kbd> full HP · <kbd>B</kbd> spawn đạn · <kbd>O</kbd> reset game · <kbd>F</kbd> fast reload · <kbd>N</kbd> bật/tắt no wall · <kbd>G</kbd> bật/tắt bất tử</div>
            </div>
        </div>
    </div>
</section>
<section id="settingsPanel" class="overlay-panel hidden" aria-label="Cài đặt">
    <div class="card settings" style="position:relative;">
        <button class="settings-close-x" id="settingsCloseX">×</button>
        <div class="settings-header">
            <h4>Cài đặt</h4>
            <p>Điều chỉnh Developer Mode, hiển thị và thông số gameplay.</p>
        </div>
    <div class="settings-grid">
        <div class="settings-group">
            <div class="settings-title">Tùy chọn</div>
            <div class="settings-row">
                <label><input type="checkbox" id="settingsDevMode"> Developer Mode</label>
            </div>
            <div class="settings-row">
                <label><input type="checkbox" id="settingsInstructions" checked> Hiển thị hướng dẫn</label>
            </div>
            <div class="settings-row">
                <label><input type="checkbox" id="settingsP1Focus"> P1 Khóa mục tiêu</label>
            </div>
            <div class="settings-row">
                <label><input type="checkbox" id="settingsP2Focus"> P2 Khóa mục tiêu</label>
            </div>
        </div>
        <div class="settings-group">
            <div class="settings-title">Thông số</div>
            <div class="settings-row">
                <span>Max HP</span>
                <input id="settingsMaxHp" class="settings-input" type="number" step="0.1" min="0.1" value="3">
            </div>
            <div class="settings-row">
                <span>Tốc độ</span>
                <input id="settingsSpeed" class="settings-input" type="number" step="0.01" min="0.01" value="0.5">
            </div>
            <div class="settings-row">
                <span>Số đạn tối đa</span>
                <input id="settingsAmmo" class="settings-input" type="number" step="1" min="1" value="3">

            </div>
            <div class="settings-row">
                <span>Thời gian nạp đạn (ms)</span>
                <input id="settingsReload" class="settings-input" type="number" step="10" min="0" value="320">

            </div>
            <div class="settings-row">
                <span>Tốc độ quay</span>
                <input id="settingsTurnSpeed" class="settings-input" type="number" step="0.01" min="0.01" value="0.06">

            </div>
            <div class="settings-row">
                <span>Ma sát</span>
                <input id="settingsFriction" class="settings-input" type="number" step="0.01" min="0.01" max="1" value="0.93">

            </div>
            <div class="settings-row">
                <span>Tốc độ hồi đạn</span>
                <input id="settingsReloadRate" class="settings-input" type="number" step="0.001" min="0.001" value="0.0167">

            </div>
        </div>
        <div class="settings-group">
            <div class="settings-title">Hành động</div>
            <div class="settings-actions">
                <button id="settingsFullscreenBtn">Toàn màn hình</button>
            </div>
        </div>
        <div class="settings-group">
            <div class="settings-title">VS Boss Mode</div>
            <div class="settings-actions">
                <button class="btn" id="bossModeBtn2P">2 Players VS Boss</button>
                <button class="btn" id="exitBossModeBtn" style="margin-top: 10px; --btn-from: #ff4757; --btn-to: #ff3742; --btn-shadow: rgba(255,71,87,0.3); display: none;">Exit Boss Mode</button>
            </div>
        </div>
    </div>
    </div>
</section>
<!-- Game canvas container -->
<div class="game-container">
    <canvas id="c" width="900" height="560"></canvas>
    
    <!-- Main Menu Overlay -->
    <div id="mainMenuOverlay" class="main-menu-overlay">
        <div class="main-menu-container">
            <h1 class="main-menu-title">Ngạo nghễ Kaguyacon</h1>
            <p class="main-menu-subtitle">Đế vương phải có long ngai</p>
            
            <div class="main-menu-buttons">
                <button class="menu-btn menu-btn-primary" id="menuBtnPvP">Player vs Player</button>
                
                <button class="menu-btn menu-btn-boss" id="menuBtnBoss">VS Boss Mode</button>
                
                <button class="menu-btn menu-btn-settings" id="menuBtnSettings">Settings</button>
            </div>
            
            <div class="menu-version">Version 2.0.0</div>
        </div>
    </div>
    
    <!-- Game UI will be drawn on canvas -->
</div>
<div id="devInstructionsCard" class="card hidden" style="position: absolute; top: 60px; right: 10px; width: 280px; max-height: 450px; overflow-y: auto; z-index: 100; padding: 15px; background: rgba(20, 30, 45, 0.9); border: 1px solid #4a5568;">
    <h3 style="margin-top: 0; color: #ffd700; border-bottom: 1px solid #4a5568; padding-bottom: 8px;">Dev Mode Keys</h3>
    <div style="display: grid; grid-template-columns: auto 1fr; gap: 5px 15px; font-size: 13px;">
        <strong style="color: #a0aec0;">H:</strong> <span style="color: #e2e8f0;">Hồi đầy HP</span>
        <strong style="color: #a0aec0;">O:</strong> <span style="color: #e2e8f0;">Reset ván đấu</span>
        <strong style="color: #a0aec0;">G:</strong> <span style="color: #e2e8f0;">Bật/Tắt Bất tử</span>
        <strong style="color: #a0aec0;">M:</strong> <span style="color: #e2e8f0;">Bật/Tắt 1-Hit Kill</span>
        <strong style="color: #a0aec0;">N:</strong> <span style="color: #e2e8f0;">Bật/Tắt Tường</span>
        <strong style="color: #a0aec0;">F:</strong> <span style="color: #e2e8f0;">Nạp đạn siêu nhanh</span>
        <strong style="color: #a0aec0;">B:</strong> <span style="color: #e2e8f0;">Tạo 1 viên đạn</span>
        
        <h4 style="grid-column: 1 / -1; color: #63b3ed; margin: 10px 0 5px;">Tạo Buff:</h4>
        <strong style="color: #a0aec0;">Z:</strong> <span style="color: #e2e8f0;">Hồi máu</span>
        <strong style="color: #a0aec0;">C:</strong> <span style="color: #e2e8f0;">Đạn tự dẫn</span>
        <strong style="color: #a0aec0;">V:</strong> <span style="color: #e2e8f0;">Tàng hình</span>
        <strong style="color: #a0aec0;">2:</strong> <span style="color: #e2e8f0;">Tăng tốc</span>
        <strong style="color: #a0aec0;">5:</strong> <span style="color: #e2e8f0;">Thu nhỏ</span>
        <strong style="color: #a0aec0;">6:</strong> <span style="color: #e2e8f0;">Khiên</span>
        <strong style="color: #a0aec0;">7:</strong> <span style="color: #e2e8f0;">Nạp nhanh</span>
        <strong style="color: #a0aec0;">8:</strong> <span style="color: #e2e8f0;">Đạn to</span>
        <strong style="color: #a0aec0;">9:</strong> <span style="color: #e2e8f0;">Phân thân</span>
        <strong style="color: #a0aec0;">0:</strong> <span style="color: #e2e8f0;">Bắn chùm</span>
        <strong style="color: #a0aec0;">Q:</strong> <span style="color: #e2e8f0;">Nảy vô hạn</span>
        <strong style="color: #a0aec0;">R:</strong> <span style="color: #e2e8f0;">Đạn nổ</span>
        <strong style="color: #a0aec0;">U:</strong> <span style="color: #e2e8f0;">Đạn xuyên</span>
        <strong style="color: #a0aec0;">I:</strong> <span style="color: #e2e8f0;">Đạn độc</span>
        <strong style="color: #a0aec0;">J:</strong> <span style="color: #e2e8f0;">Dung nham</span>
        <strong style="color: #a0aec0;">X:</strong> <span style="color: #e2e8f0;">Cuồng nộ</span>
        <strong style="color: #a0aec0;">P:</strong> <span style="color: #e2e8f0;">Bom nguyên tử</span>
        
        <h4 style="grid-column: 1 / -1; color: #f6ad55; margin: 10px 0 5px;">Tạo Debuff:</h4>
        <strong style="color: #a0aec0;">Y:</strong> <span style="color: #e2e8f0;">Kẻ địch khổng lồ</span>
        <strong style="color: #a0aec0;">E:</strong> <span style="color: #e2e8f0;">Đảo phím</span>
        <strong style_color: #a0aec0;>T:</strong> <span style="color: #e2e8f0;">Trói chân</span>
        <strong style="color: #a0aec0;">K:</strong> <span style="color: #e2e8f0;">Câm lặng</span>
        <strong style="color: #a0aec0;">L:</strong> <span style="color: #e2e8f0;">Thôi miên</span>

        <h4 style="grid-column: 1 / -1; color: #f56565; margin: 10px 0 5px;">Test Boss Mode:</h4>
        <strong style="color: #a0aec0;">1:</strong> <span style="color: #e2e8f0;">Thêm tất cả buff</span>
        <strong style="color: #a0aec0;">3:</strong> <span style="color: #e2e8f0;">Xóa tất cả buff</span>
    </div>
    <button class="settings-close-x" style="top: 12px; right: 12px;">×</button>
</div>

<!-- Instructions Panel at bottom -->
<section id="instructionsPanel" class="card bottom-panel hidden" aria-label="Hướng dẫn">
    <button class="settings-close-x" id="instructionsCloseX">×</button>
    <div class="instructions-header">
        <h4>Hướng dẫn chơi</h4>
        <p>Cách điều khiển và mẹo chơi game.</p>
    </div>
    <div class="instructions-grid">
        <div class="player-block">
            <div class="player-title">Player 1</div>
            <ul>
                <li><span>Tiến / Lùi</span><kbd>W</kbd> · <kbd>S</kbd></li>
                <li><span>Quay trái / phải</span><kbd>A</kbd> · <kbd>D</kbd></li>
                <li><span>Bắn</span><kbd>Space</kbd></li>
            </ul>
        </div>
        <div class="player-block">
            <div class="player-title">Player 2</div>
            <ul>
                <li><span>Tiến / Lùi</span><kbd>↑</kbd> · <kbd>↓</kbd></li>
                <li><span>Quay trái / phải</span><kbd>←</kbd> · <kbd>→</kbd></li>
                <li><span>Bắn</span><kbd>Enter</kbd></li>
            </ul>
        </div>
        <div class="player-block tips">
            <div class="player-title">Mẹo chơi</div>
            <ul>
                <li>Đạn nảy tối đa 8 lần trừ khi buff thay đổi.</li>
                <li>Tường và biên đều phản xạ đạn — cẩn thận tự bắn mình.</li>
                <li>Giữ phím bắn để tích năng lượng đạn mạnh hơn.</li>
            </ul>
        </div>
    </div>
</section>
<!-- Game UI Info -->
<div id="gameInfo" style="position: absolute; top: 10px; left: 10px; color: #fff; font-size: 14px; pointer-events: none; background: rgba(0,0,0,0.5); padding: 8px 12px; border-radius: 8px;">
    <div id="gameModeInfo">Mode: Player vs Player</div>
    <div id="floorInfo" style="display: none;">Floor: 1</div>
    <div id="permanentBuffsInfo" style="display: none; margin-top: 5px; font-size: 12px; color: #ffd700;">Buffs: None</div>
</div>

<!-- Boss Mode Buff Selection Overlay -->
<div id="buffSelectionOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center;">
    <div class="card" style="padding: 30px; text-align: center; max-width: 600px;">
        <h2 style="margin-bottom: 20px; color: #ffd700;">Choose Your Permanent Buff</h2>
        <p style="margin-bottom: 30px; color: #ccc;">This buff will last for the rest of your Boss Mode run!</p>
        <div id="buffOptions" style="display: flex; gap: 20px; justify-content: center;">
            <!-- Buff options will be populated by JavaScript -->
        </div>
        <div style="margin-top: 20px; font-size: 14px; color: #888;">
            <p>Press 1, 2, or 3 to select a buff</p>
        </div>
    </div>
</div>

<script type="module" src="js/main.js"></script>
<script>
    // --- Draggable Dev Instructions Panel ---
    const panel = document.getElementById('devInstructionsCard');
    const header = panel.querySelector('h3');

    // --- Close Button Logic ---
    const closeBtn = panel.querySelector('.settings-close-x');
    if (closeBtn) {
        closeBtn.addEventListener('click', () => panel.classList.add('hidden'));
    }

    // --- Dragging Logic ---
    let isDragging = false;
    let offsetX, offsetY;

    if (header) {
        header.style.cursor = 'move';
        header.style.userSelect = 'none';

        header.addEventListener('mousedown', (e) => {
            if (e.target !== header) return; // Only drag if mousedown is on the header itself
            isDragging = true;
            
            // Calculate offset from the top-left corner of the panel
            offsetX = e.clientX - panel.offsetLeft;
            offsetY = e.clientY - panel.offsetTop;

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
    }

    function onMouseMove(e) {
        if (!isDragging) return;

        // Calculate new position
        let newX = e.clientX - offsetX;
        let newY = e.clientY - offsetY;

        panel.style.left = `${newX}px`;
        panel.style.top = `${newY}px`;
    }

    function onMouseUp() {
        isDragging = false;
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
    }

    // --- Resizing Logic ---
    let isResizing = false;
    let resizeDirections = { top: false, right: false, bottom: false, left: false };
    let startX, startY, startWidth, startHeight, startLeft, startTop;
    const borderZone = 8; // 8px area around the edges for resizing

    panel.addEventListener('mousemove', (e) => {
        if (isResizing || isDragging) return;

        const rect = panel.getBoundingClientRect();
        const onLeft = Math.abs(e.clientX - rect.left) < borderZone;
        const onRight = Math.abs(e.clientX - rect.right) < borderZone;
        const onTop = Math.abs(e.clientY - rect.top) < borderZone;
        const onBottom = Math.abs(e.clientY - rect.bottom) < borderZone;

        if ((onTop && onLeft) || (onBottom && onRight)) {
            panel.style.cursor = 'nwse-resize';
        } else if ((onTop && onRight) || (onBottom && onLeft)) {
            panel.style.cursor = 'nesw-resize';
        } else if (onTop || onBottom) {
            panel.style.cursor = 'ns-resize';
        } else if (onLeft || onRight) {
            panel.style.cursor = 'ew-resize';
        } else {
            panel.style.cursor = 'default';
        }
    });

    panel.addEventListener('mousedown', (e) => {
        // Prevent resizing when clicking the header or close button
        if (e.target === header || e.target === closeBtn) return;

        const rect = panel.getBoundingClientRect();
        resizeDirections.top = Math.abs(e.clientY - rect.top) < borderZone;
        resizeDirections.bottom = Math.abs(e.clientY - rect.bottom) < borderZone;
        resizeDirections.left = Math.abs(e.clientX - rect.left) < borderZone;
        resizeDirections.right = Math.abs(e.clientX - rect.right) < borderZone;

        if (Object.values(resizeDirections).some(dir => dir)) {
            isResizing = true;
            e.preventDefault();

            startX = e.clientX;
            startY = e.clientY;
            startWidth = panel.offsetWidth;
            startHeight = panel.offsetHeight;
            startLeft = panel.offsetLeft;
            startTop = panel.offsetTop;

            document.addEventListener('mousemove', handleResizeMove);
            document.addEventListener('mouseup', handleResizeUp);
        }
    });

    function handleResizeMove(e) {
        if (!isResizing) return;

        const dx = e.clientX - startX;
        const dy = e.clientY - startY;

        if (resizeDirections.right) {
            panel.style.width = `${startWidth + dx}px`;
        }
        if (resizeDirections.bottom) {
            panel.style.height = `${startHeight + dy}px`;
        }
        if (resizeDirections.left) {
            panel.style.width = `${startWidth - dx}px`;
            panel.style.left = `${startLeft + dx}px`;
        }
        if (resizeDirections.top) {
            panel.style.height = `${startHeight - dy}px`;
            panel.style.top = `${startTop + dy}px`;
        }
    }

    function handleResizeUp() {
        isResizing = false;
        resizeDirections = { top: false, right: false, bottom: false, left: false };
        document.removeEventListener('mousemove', handleResizeMove);
        document.removeEventListener('mouseup', handleResizeUp);
    }

    // --- Click outside to close settings panel ---
    const settingsPanel = document.getElementById('settingsPanel');
    if (settingsPanel) {
        settingsPanel.addEventListener('click', (e) => {
            // If the click is on the overlay itself (the background), close the panel.
            if (e.target === settingsPanel) {
                settingsPanel.classList.add('hidden');
            }
        });
    }

    // --- Close Instructions Panel ---
    const instructionsPanel = document.getElementById('instructionsPanel');
    const instructionsCloseBtn = document.getElementById('instructionsCloseX');
    if (instructionsPanel && instructionsCloseBtn) {
        instructionsCloseBtn.addEventListener('click', () => {
            instructionsPanel.classList.add('hidden');
        });
    }
</script>
</body>
</html>